<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - JBR Tanching C.O</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/orders.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/my_account.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-left">
                <a href="{{ url_for('views.home') }}" class="nav-logo">
                    <img src="{{ url_for('static', filename='pictures/logo.ico') }}" alt="Logo" class="logo-image">
                    <h2 class="logo-text">JBR Tanching C.O</h2>
                </a>
            </div>

            <div class="search-bar">
                <select class="search-dropdown">
                    <option>All</option>
                    <option>Fabrics</option>
                    <option>Sewing Machines</option>
                    <option>Sewing Parts</option>
                </select>
                <input type="text" class="search-input" placeholder="What can we help you find?">
                <button class="search-btn">
                    <img src="{{ url_for('static', filename='pictures/search.png') }}" alt="Search" class="icon-img">
                </button>
            </div>

            <div class="nav-icons">
                <span class="phone-info">
                    <img src="{{ url_for('static', filename='pictures/contact.png') }}" alt="Contact" class="icon-img non-clickable"> 
                    <span class="phone-text">+63 912-3456-789</span>
                </span>
                <a href="{{ url_for('auth.cart') }}" class="cart-link">
                    <img src="{{ url_for('static', filename='pictures/cart.png') }}" alt="Cart" class="icon-img">
                </a>

                <div class="user-dropdown">
                    <div class="user-info" id="userInfo">
                        <img src="{{ url_for('static', filename='pictures/user.png') }}" alt="User" class="icon-img" id="user-icon">
                        <span class="username" id="usernameDisplay"></span>
                    </div>
                    <div class="dropdown-container" id="dropdownMenu">
                    </div>
                </div> 
            </div> 
        </nav>
    </header>

    <main class="my-account-container">
        <div class="container">
            <div class="account-wrapper">
                <div class="sidebar">
                    <div class="user-profile">
                        <img src="{% if user.profile_image and user.profile_image.startswith('http') %}{{ user.profile_image }}{% elif user.profile_image %}{{ url_for('static', filename='profile_images/' ~ user.profile_image) }}{% else %}{{ url_for('static', filename='pictures/user-circle.png') }}{% endif %}"
                             alt="Profile" id="profileImage" class="profile-image" data-image="{{ user.profile_image if user.profile_image else '' }}">
                        <div class="user-info">
                            <div class="user-name-section">
                                <h3 id="sidebarUsername"></h3>
                                <div class="green-line">
                                    <button class="edit-profile-btn" id="editProfileBtn">✏️ Edit Profile</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="parent-menu"><a href="{{ url_for('auth.my_account') }}"><i class="fas fa-user"></i> My Account</a></li>
                        <li class="sub-menu"><a href="{{ url_for('auth.addresses') }}"><i class="fas fa-map-marker-alt"></i> Addresses</a></li>
                        <li class="sub-menu"><a href="{{ url_for('auth.change_password') }}"><i class="fas fa-lock"></i> Change Password</a></li>
                        <li class="sub-menu"><a href="{{ url_for('auth.privacy_settings') }}"><i class="fas fa-shield-alt"></i> Privacy Settings</a></li>
                        <li class="active"><a href="{{ url_for('auth.orders') }}"><i class="fas fa-shopping-bag"></i> Orders</a></li>
                    </ul>
                </div>
                
                <div class="account-content">
                    <h2 class="page-title">My Orders</h2>
                    <p class="page-subtitle">View and manage your orders</p>
                    
                    <div class="orders-tabs">
                        <div class="tab active" data-tab="all">All</div>
                        <div class="tab" data-tab="to-pay">To Pay</div>
                        <div class="tab" data-tab="to-ship">To Ship</div>
                        <div class="tab" data-tab="to-receive">To Receive</div>
                        <div class="tab" data-tab="completed">Completed</div>
                        <div class="tab" data-tab="cancelled">Cancelled</div>
                        <div class="tab" data-tab="return-refund">Return/Refund</div>
                    </div>
                    
                    <div class="search-order">
                        <input type="text" id="orderSearch" placeholder="You can search by Order ID or Product name">
                        <button id="searchBtn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <div class="orders-container" id="ordersContainer">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="success-message" id="successMessage">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <p id="successText">Order action successful</p>
    </div>

    <div class="email-modal-overlay" id="emailModalOverlay" style="display:none;">
      <div class="email-modal" style="background:#fff; border-radius:10px; box-shadow:0 8px 32px rgba(0,0,0,0.18); padding:24px 20px; width:95%; max-width:420px; max-height:90vh; overflow-y:auto; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000;">
        <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between;">
          <span class="modal-title" style="font-weight:600; font-size:1.2em;">Contact Seller</span>
          <button class="close-modal-btn" id="closeEmailModal" style="font-size:1.5em; background:none; border:none; cursor:pointer;">&times;</button>
        </div>
        <form id="emailForm" enctype="multipart/form-data">
          <input type="hidden" id="emailOrderId" name="order_id">
          <div class="modal-body">
            <label for="emailSubject">Subject:</label>
            <select id="emailSubject" name="subject" required style="width:100%;margin-bottom:10px;">
              <option value="Order Issue">Order Issue</option>
              <option value="Product Inquiry">Product Inquiry</option>
              <option value="Shipping Concern">Shipping Concern</option>
              <option value="Other">Other</option>
            </select>
            <input type="text" id="customSubjectInput" name="custom_subject" placeholder="Enter custom subject" style="width:100%;margin-bottom:10px;display:none;">
            <label for="emailMessage">Message:</label>
            <textarea id="emailMessage" name="message" rows="5" required style="width:100%;"></textarea>
            <label for="emailAttachment" style="margin-top:10px;display:block;">Attachment (optional):</label>
            <input type="file" id="emailAttachment" name="attachment" style="margin-bottom:10px;">
          </div>
          <div class="modal-footer" style="display:flex; justify-content:flex-end; margin-top:10px;">
            <button type="submit" class="submit-btn" style="background:#ffb400; color:#fff; border:none; border-radius:5px; padding:10px 24px; font-weight:600; cursor:pointer;">Send Email</button>
          </div>
        </form>
      </div>
    </div>

<!-- Modernized Rating Modal -->
<div class="rating-modal-overlay" id="ratingModalOverlay" style="display:none;">
  <div class="rating-modal">
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between;">
      <span class="modal-title" style="font-weight:600; font-size:1.2em;">Rate Product</span>
      <button class="close-modal-btn" id="closeRatingModal" style="font-size:1.5em; background:none; border:none; cursor:pointer;">&times;</button>
    </div>
    <form id="ratingForm">
      <div class="modal-body">
        <div class="product-info-row" style="display:flex; align-items:center; gap:14px; margin-bottom:16px;">
          <img src="" alt="Product" class="product-modal-img" id="ratingProductImg" style="width:48px; height:48px; object-fit:cover; border-radius:8px; background:#f3f3f3;">
          <div>
            <div class="product-modal-name" id="ratingProductName" style="font-weight:500;">Product Name</div>
            <div id="ratingProductQty" style="font-size:0.95em; color:#888;"></div>
            <div class="product-modal-variant" id="ratingProductVariant" style="font-size:0.95em; color:#888;">Variant/Subtitle</div>
            <div id="debugIdInfo" style="font-size:0.9em; color:#b00; margin-top:4px;"></div>
            <!-- Product selector -->
            <div id="productSelectorContainer" style="margin-top:8px;"></div>
          </div>
        </div>
        <div class="star-row" id="starRow" style="font-size:2em; color:#ffb400; margin-bottom:16px;">
          <span class="star" data-value="1">&#9733;</span>
          <span class="star" data-value="2">&#9733;</span>
          <span class="star" data-value="3">&#9733;</span>
          <span class="star" data-value="4">&#9733;</span>
          <span class="star" data-value="5">&#9733;</span>
        </div>
        <div class="media-row" style="display:flex; gap:12px; margin-bottom:16px;">
          <label class="media-btn" style="display:flex; align-items:center; gap:6px; border:1.5px solid #ffa600; background:#fffbe6; color:#b26a00; border-radius:6px; padding:8px 18px; cursor:pointer;">
            <i class="fa fa-camera"></i> Add Photo
            <input type="file" id="addPhotoInput" accept="image/*" style="display:none;">
          </label>
          <div id="photoPreviewContainer"></div>
          <label class="media-btn" style="display:flex; align-items:center; gap:6px; border:1.5px solid #ffa600; background:#fffbe6; color:#b26a00; border-radius:6px; padding:8px 18px; cursor:pointer;">
            <i class="fa fa-video"></i> Add Video
            <input type="file" id="addVideoInput" accept="video/*" style="display:none;">
          </label>
        </div>
        <textarea id="reviewText" placeholder="Write your review..." maxlength="600" style="width:100%; min-height:70px; padding:10px; border-radius:5px; border:1px solid #ddd;"></textarea>
        <div class="char-count" id="charCount" style="text-align:right; color:#888; font-size:0.95em;">0/600</div>
      </div>
      <div class="modal-footer" style="display:flex; justify-content:flex-end; margin-top:10px;">
        <button type="submit" class="submit-btn" id="submitRatingBtn" style="background:#ffb400; color:#fff; border:none; border-radius:5px; padding:10px 24px; font-weight:600; cursor:pointer;">Submit</button>
      </div>
    </form>
  </div>
</div>
<!-- End Modernized Rating Modal -->

<!-- Cancel Reason Modal Modernized -->
<div class="cancel-modal-overlay" id="cancelModalOverlay">
  <div class="cancel-modal" role="dialog" aria-modal="true" aria-labelledby="cancelTitle">
    <h2 id="cancelTitle">Cancel Order</h2>
    <p style="color:#444; font-size:15px; margin-bottom:18px;">Please let us know why you want to cancel this order. This helps us improve our service. <br><b style="color:#e63946; font-weight:500;">This will cancel all items in the order and cannot be undone.</b></p>
    <form id="cancelForm">
      <div class="cancel-reason">
        {% for reason in cancellation_reasons %}
          <label>
            <input type="radio" name="cancel_reason" value="{{ reason.cancellation_reason_id }}" {% if reason.cancellation_reason_name|lower == 'other' %}id="otherRadio"{% endif %}>
            {{ reason.cancellation_reason_name }}
            {% if reason.cancellation_reason_name|lower == 'other' %}
              <input type="text" id="otherText" name="otherText" placeholder="Please specify" style="display:none; margin-left:10px; width:70%;">
            {% endif %}
          </label><br>
        {% endfor %}
      </div>
      <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
        <button type="button" class="modal-btn" id="cancelModalNotNowBtn">Not Now</button>
        <button type="button" class="modal-btn modal-btn-danger" id="confirmCancelBtn" disabled>Cancel Order</button>
      </div>
    </form>
  </div>
</div>
<!-- End Cancel Reason Modal Modernized -->

<!-- Refund Request Modal -->
<div class="refund-modal-overlay" id="refundModalOverlay">
  <div class="refund-modal" role="dialog" aria-modal="true" aria-labelledby="refundTitle">
    <h2 id="refundTitle">Select Reason to Refund</h2>
    <form id="refundForm">
      <div class="refund-reason-section" id="refundReasonSection">
        <div class="refund-radio-group" id="mainOptionsGroup">
          <label class="refund-radio-option" id="receivedOptionLabel">
            <input type="radio" name="items_received" value="yes">
            <span>I have received my items but there are issues</span>
          </label>
          <div class="sub-reasons" id="receivedSubReasons" style="display:none;">
            <label class="refund-radio-option">
              <input type="radio" name="refund_reason" value="missing_parts">
              <span>Missing part of the order</span>
            </label>
            <label class="refund-radio-option">
              <input type="radio" name="refund_reason" value="wrong_item">
              <span>Seller sent wrong item</span>
            </label>
            <label class="refund-radio-option" id="damagedItemOption">
              <input type="radio" name="refund_reason" value="damaged">
              <span>Damaged Item</span>
            </label>
            <div class="sub-reasons" id="damagedSubReasons" style="display:none; margin-left:32px; margin-top:2px;">
              <label class="refund-radio-option">
                <input type="radio" name="damage_type" value="shattered">
                <span>Shattered/Broken Product</span>
              </label>
              <label class="refund-radio-option">
                <input type="radio" name="damage_type" value="scratched">
                <span>Scratch/Dents</span>
              </label>
              <label class="refund-radio-option">
                <input type="radio" name="damage_type" value="other_damage">
                <span>Other types of damage</span>
              </label>
            </div>
            <label class="refund-radio-option">
              <input type="radio" name="refund_reason" value="defective">
              <span>Product is defective or does not work</span>
            </label>
          </div>
          <label class="refund-radio-option" id="notReceivedOptionLabel">
            <input type="radio" name="items_received" value="no">
            <span>I didn't receive my items</span>
          </label>
          <div class="sub-reasons" id="notReceivedSubReasons" style="display:none;">
            <label class="refund-radio-option">
              <input type="radio" name="refund_reason" value="not_delivered">
              <span>Parcel not delivered</span>
            </label>
            <label class="refund-radio-option">
              <input type="radio" name="refund_reason" value="missing_parts">
              <span>Missing part of the order</span>
            </label>
            <label class="refund-radio-option">
              <input type="radio" name="refund_reason" value="empty_parcel">
              <span>Empty Parcel</span>
            </label>
          </div>
        </div>
      </div>
      <div class="refund-description" style="margin-top:24px;">
        <label for="refundDescription">Description:</label>
        <textarea id="refundDescription" name="refundDescription" rows="4" placeholder="Please provide details about your refund request..."></textarea>
      </div>
      <div class="proof-upload" style="margin-top:18px;">
        <label>Upload Proof (Photo/Video):</label>
        <div class="upload-container">
          <input type="file" id="proofFile" name="proofFile" accept="image/*,video/*" multiple>
          <div id="fileList" class="file-list"></div>
        </div>
      </div>
      <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
        <button type="button" class="modal-btn" id="refundModalNotNowBtn">Cancel</button>
        <button type="button" class="modal-btn modal-btn-danger" id="confirmRefundBtn" disabled>Submit</button>
      </div>
    </form>
  </div>
</div>
<!-- End Refund Request Modal -->

    <footer>
        <div class="container footer-grid">
            <div class="footer-section">
                <h3>About Us</h3>
                <p>JBR Tanching C.O has been delivering high-quality sewing machines, parts, and fabrics since 2014. We're committed to supporting your creativity with reliable products and expert service.</p>
            </div>

            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="{{ url_for('views.home') }}">Home</a></li>
                    <li><a href="{{ url_for('views.about') }}">About</a></li>
                    <li><a href="{{ url_for('views.contact') }}">Contact</a></li>
                </ul>
            </div>

            <div class="footer-section payment-section">
                <h3>Payment Methods</h3>
                <div class="payment-icons">
                    <img src="{{ url_for('static', filename='pictures/bank-icon.png') }}" alt="Bank Transfer" class="payment-icon">
                    <img src="{{ url_for('static', filename='pictures/gcash-icon.png') }}" alt="GCash" class="payment-icon">
                    <img src="{{ url_for('static', filename='pictures/cod-icon.png') }}" alt="Cash on Delivery" class="payment-icon">
                </div>
            </div>

            <div class="footer-section contact-section">
                <div class="footer-logo">
                    <img src="{{ url_for('static', filename='pictures/logo.ico') }}" alt="JBR Tanching C.O Logo" class="footer-logo-img">
                </div>
                <div class="contact-info">
                    <h3>JBR Tanching C.O</h3>
                    <p class="contact-phone">(02) 8123-4567</p>
                </div>
            </div>
        </div>
        <div class="copyright">
            <p>© 2014-2025 JBR TANCHING C.O JOSE ABAD SANTOS, TONDO, MANILA, PHILIPPINES. All Rights Reserved</p>
        </div>
    </footer>

    <script id="orders-data" type="application/json">
        {{ orders|tojson|safe }}
    </script>
    <script src="{{ url_for('static', filename='js/orders.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add click event listener to track order buttons
        document.querySelectorAll('.track-order-btn').forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                window.location.href = `/track-order/${orderId}`;
            });
        });
    });
    </script>

<style>
.refund-radio-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.refund-radio-option {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.08em;
  padding: 4px 0;
}
.refund-radio-option input[type="radio"] {
  margin-top: 0;
}
.sub-reasons {
  margin-left: 32px;
  margin-top: 2px;
}
.modal-btn-danger {
  background-color: #e63946;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.modal-btn-danger:disabled {
  background-color: #ccc;
  cursor: not-allowed;
  opacity: 0.7;
}
.modal-btn-danger:not(:disabled) {
  background-color: #e63946;
  cursor: pointer;
  opacity: 1;
}
.modal-btn-danger:not(:disabled):hover {
  background-color: #d62839;
}
.file-list {
  margin-top: 10px;
  max-height: 100px;
  overflow-y: auto;
}
.file-list div {
  padding: 5px;
  background-color: #f8f9fa;
  margin-bottom: 5px;
  border-radius: 4px;
}
.rating-modal-overlay {
  display: none; /* Hidden by default */
  align-items: center;
  justify-content: center;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}
.rating-modal {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  padding: 24px 20px;
  width: 95%;
  max-width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}
</style>
<script>
function updateSubReasons() {
  const receivedRadio = document.querySelector('input[name="items_received"][value="yes"]');
  const notReceivedRadio = document.querySelector('input[name="items_received"][value="no"]');
  const receivedSubReasons = document.getElementById('receivedSubReasons');
  const notReceivedSubReasons = document.getElementById('notReceivedSubReasons');
  const damagedRadio = document.querySelector('input[name="refund_reason"][value="damaged"]');
  const damagedSubReasons = document.getElementById('damagedSubReasons');

  if (receivedSubReasons && receivedRadio) {
    receivedSubReasons.style.display = receivedRadio.checked ? 'block' : 'none';
  }
  if (notReceivedSubReasons && notReceivedRadio) {
    notReceivedSubReasons.style.display = notReceivedRadio.checked ? 'block' : 'none';
  }

  // Hide damaged sub-reasons if not selected
  if (damagedSubReasons) {
    if (!damagedRadio || !damagedRadio.checked) {
      damagedSubReasons.style.display = 'none';
      damagedSubReasons.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
    } else {
      damagedSubReasons.style.display = 'block';
    }
  }
  validateRefundForm();
}

function validateRefundForm() {
  const mainSelected = document.querySelector('input[name="items_received"]:checked');
  const refundReasonSelected = document.querySelector('input[name="refund_reason"]:checked');
  const confirmRefundBtn = document.getElementById('confirmRefundBtn');
  if (confirmRefundBtn) {
    const isValid = mainSelected && refundReasonSelected;
    confirmRefundBtn.disabled = !isValid;
    if (isValid) {
      confirmRefundBtn.classList.add('active');
    } else {
      confirmRefundBtn.classList.remove('active');
    }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Attach event listeners for main and sub-reason logic
  document.querySelectorAll('input[name="items_received"]').forEach(el => {
    el.addEventListener('change', updateSubReasons);
  });
  document.querySelectorAll('input[name="refund_reason"]').forEach(el => {
    el.addEventListener('change', updateSubReasons);
  });
  document.querySelectorAll('input[name="damage_type"]').forEach(el => {
    el.addEventListener('change', validateRefundForm);
  });

  // File input validation and file list display
  const proofFileInput = document.getElementById('proofFile');
  if (proofFileInput) {
    proofFileInput.addEventListener('change', function() {
      validateRefundForm();
      const fileList = document.getElementById('fileList');
      if (fileList) {
        fileList.innerHTML = '';
        Array.from(this.files).forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.textContent = file.name;
          fileList.appendChild(fileItem);
        });
      }
    });
  }

  // Initial state
  updateSubReasons();

  // Submit handler
  const confirmRefundBtn = document.getElementById('confirmRefundBtn');
  if (confirmRefundBtn) {
    confirmRefundBtn.disabled = false;
    confirmRefundBtn.classList.add('active');
  }

  // Cancel button handler
  const refundModalNotNowBtn = document.getElementById('refundModalNotNowBtn');
  if (refundModalNotNowBtn) {
    refundModalNotNowBtn.addEventListener('click', function() {
      document.getElementById('refundModalOverlay').style.display = 'none';
      document.getElementById('refundForm').reset();
      updateSubReasons();
    });
  }
});

// Helper to open modal with orderId
function openRefundModal(orderId) {
  const refundForm = document.getElementById('refundForm');
  if (refundForm) {
    refundForm.dataset.orderId = orderId;
    refundForm.reset();
    const fileList = document.getElementById('fileList');
    if (fileList) fileList.innerHTML = '';
    updateSubReasons();
  }
  document.getElementById('refundModalOverlay').style.display = 'block';

  // Attach event listeners every time modal opens
  document.querySelectorAll('input[name="items_received"]').forEach(el => {
    el.onchange = updateSubReasons;
  });
  document.querySelectorAll('input[name="refund_reason"]').forEach(el => {
    el.onchange = updateSubReasons;
  });
  document.querySelectorAll('input[name="damage_type"]').forEach(el => {
    el.onchange = validateRefundForm;
  });
  const proofFileInput = document.getElementById('proofFile');
  if (proofFileInput) {
    proofFileInput.onchange = function() {
      validateRefundForm();
      const fileList = document.getElementById('fileList');
      if (fileList) {
        fileList.innerHTML = '';
        Array.from(this.files).forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.textContent = file.name;
          fileList.appendChild(fileItem);
        });
      }
    };
  }
  // Initial validation
  validateRefundForm();
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sidebar username
  const sidebarUsername = document.getElementById('sidebarUsername');
  if (sidebarUsername) {
    sidebarUsername.textContent = (typeof USERNAME !== 'undefined' && USERNAME) ? USERNAME : (localStorage.getItem('username') || '');
  }

  // --- Rating Modal Logic ---
  let selectedRating = 0;
  let currentProductId = null;
  let currentOrderId = null;
  const stars = document.querySelectorAll('#starRow .star');
  stars.forEach(star => {
    star.addEventListener('mouseenter', function() {
      const val = parseInt(this.getAttribute('data-value'));
      stars.forEach((s, i) => {
        s.style.color = i < val ? '#ffb400' : '#ccc';
      });
    });
    star.addEventListener('mouseleave', function() {
      stars.forEach((s, i) => {
        s.style.color = i < selectedRating ? '#ffb400' : '#ccc';
      });
    });
    star.addEventListener('click', function() {
      selectedRating = parseInt(this.getAttribute('data-value'));
      stars.forEach((s, i) => {
        s.style.color = i < selectedRating ? '#ffb400' : '#ccc';
      });
    });
  });

  const reviewText = document.getElementById('reviewText');
  const charCount = document.getElementById('charCount');
  reviewText.addEventListener('input', function() {
    charCount.textContent = `${reviewText.value.length}/600`;
  });

  // File name and preview logic for photo/video
  const addPhotoInput = document.getElementById('addPhotoInput');
  const addVideoInput = document.getElementById('addVideoInput');
  const photoFileName = document.createElement('div');
  photoFileName.style.fontSize = '0.95em';
  photoFileName.style.color = '#444';
  photoFileName.style.marginTop = '4px';
  addPhotoInput.parentElement.appendChild(photoFileName);
  // Move photo preview to dedicated container
  const photoPreviewContainer = document.getElementById('photoPreviewContainer');
  const photoPreview = document.createElement('img');
  photoPreview.style.maxWidth = '80px';
  photoPreview.style.maxHeight = '80px';
  photoPreview.style.display = 'none';
  photoPreview.style.marginTop = '4px';
  photoPreviewContainer.appendChild(photoPreview);
  addPhotoInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      photoFileName.textContent = `Selected: ${this.files[0].name}`;
      const reader = new FileReader();
      reader.onload = function(e) {
        photoPreview.src = e.target.result;
        photoPreview.style.display = 'block';
      };
      reader.readAsDataURL(this.files[0]);
    } else {
      photoFileName.textContent = '';
      photoPreview.style.display = 'none';
    }
  });
  const videoFileName = document.createElement('div');
  videoFileName.style.fontSize = '0.95em';
  videoFileName.style.color = '#444';
  videoFileName.style.marginTop = '4px';
  addVideoInput.parentElement.appendChild(videoFileName);
  const videoPreview = document.createElement('video');
  videoPreview.style.maxWidth = '120px';
  videoPreview.style.maxHeight = '80px';
  videoPreview.style.display = 'none';
  videoPreview.style.marginTop = '4px';
  videoPreview.controls = true;
  addVideoInput.parentElement.appendChild(videoPreview);
  addVideoInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      videoFileName.textContent = `Selected: ${this.files[0].name}`;
      const url = URL.createObjectURL(this.files[0]);
      videoPreview.src = url;
      videoPreview.style.display = 'block';
    } else {
      videoFileName.textContent = '';
      videoPreview.style.display = 'none';
    }
  });

  // Open modal only on .rate-btn click
  const ratingModalOverlay = document.getElementById('ratingModalOverlay');
  const ratingForm = document.getElementById('ratingForm');
  const orders = window.orders || [];
  document.querySelectorAll('.rate-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const orderId = btn.getAttribute('data-order-id');
      const productId = btn.getAttribute('data-product-id');
      currentOrderId = parseInt(orderId);
      currentProductId = parseInt(productId);
      console.log('Set IDs:', currentOrderId, currentProductId);
      if (isNaN(currentOrderId) || isNaN(currentProductId)) {
        alert('Invalid product or order ID! (NaN)');
        return;
      }
      const order = orders.find(o => o.id == currentOrderId);
      if (!order) return;
      const product = order.products.find(p => (p.product_id == currentProductId || p.id == currentProductId));
      if (!product) return;
      document.getElementById('ratingProductImg').src = product.image;
      document.getElementById('ratingProductName').textContent = product.name;
      document.getElementById('ratingProductQty').textContent = 'Qty: ' + (product.quantity || 1);
      document.getElementById('ratingProductVariant').textContent = product.variation || '';
      document.getElementById('debugIdInfo').textContent = `Order ID: ${currentOrderId} | Product ID: ${currentProductId}`;
      // Reset modal fields
      selectedRating = 0;
      stars.forEach(s => s.style.color = '#ccc');
      ratingForm.reset();
      charCount.textContent = '0/600';
      photoFileName.textContent = '';
      photoPreview.style.display = 'none';
      videoFileName.textContent = '';
      videoPreview.style.display = 'none';
      // Show modal
      ratingModalOverlay.style.display = 'flex';
    });
  });

  // Close modal on X button
  document.getElementById('closeRatingModal').addEventListener('click', function() {
    ratingModalOverlay.style.display = 'none';
    selectedRating = 0;
    stars.forEach(s => s.style.color = '#ccc');
    ratingForm.reset();
    charCount.textContent = '0/600';
    photoFileName.textContent = '';
    photoPreview.style.display = 'none';
    videoFileName.textContent = '';
    videoPreview.style.display = 'none';
  });
  // Optional: close modal when clicking outside modal content
  ratingModalOverlay.addEventListener('click', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
      selectedRating = 0;
      stars.forEach(s => s.style.color = '#ccc');
      ratingForm.reset();
      charCount.textContent = '0/600';
      photoFileName.textContent = '';
      photoPreview.style.display = 'none';
      videoFileName.textContent = '';
      videoPreview.style.display = 'none';
    }
  });
  // Submit handler
  ratingForm.addEventListener('submit', function(e) {
    e.preventDefault();
    // Get IDs directly from modal display
    const debugIdText = document.getElementById('debugIdInfo').textContent;
    const orderIdMatch = debugIdText.match(/Order ID: (\d+)/);
    const productIdMatch = debugIdText.match(/Product ID: (\d+)/);
    const orderId = orderIdMatch ? parseInt(orderIdMatch[1]) : null;
    const productId = productIdMatch ? parseInt(productIdMatch[1]) : null;
    const rating = selectedRating;
    if (!orderId || !productId) {
      alert('Order ID or Product ID missing!');
      return;
    }
    if (!rating || rating < 1 || rating > 5) {
      alert('Please select a star rating!');
      return;
    }
    const review = document.getElementById('reviewText').value;
    const photo = document.getElementById('addPhotoInput').files[0] || null;
    const video = document.getElementById('addVideoInput').files[0] || null;
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('order_id', orderId);
    formData.append('rating', rating);
    formData.append('review', review);
    if (photo) formData.append('photo', photo);
    if (video) formData.append('video', video);
    fetch('/api/submit-review', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('Thank you for your review!');
        ratingModalOverlay.style.display = 'none';
        // Hide the Rate button for this product
        const rateBtn = document.querySelector(`.rate-btn[data-order-id='${orderId}'][data-product-id='${productId}']`);
        if (rateBtn) rateBtn.style.display = 'none';
        // Reset star rating to 0
        selectedRating = 0;
        stars.forEach(s => s.style.color = '#ccc');
      } else {
        alert(data.message || 'Failed to submit review.');
      }
    })
    .catch(() => {
      alert('Network error. Please try again.');
    });
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('ordersContainer').addEventListener('click', function(e) {
    if (e.target.classList.contains('contact-seller-btn')) {
      e.preventDefault();
      const btn = e.target;
      const orderCard = btn.closest('.order-card');
      const orderId = orderCard ? orderCard.getAttribute('data-order-id') : '';
      // Find the first product item in the order card
      let productName = '';
      let productVariant = '';
      let productLink = '';
      let productId = '';
      let productType = '';
      const productItem = orderCard ? orderCard.querySelector('.order-item') : null;
      if (productItem) {
        // Product name and link info
        const nameElem = productItem.querySelector('.order-item-link');
        if (nameElem) {
          productName = nameElem.textContent.trim();
          productId = nameElem.getAttribute('data-item-id');
          productType = nameElem.getAttribute('data-type') || 'sm';
        }
        // Product variant
        const variantElem = productItem.querySelector('p');
        if (variantElem && variantElem.textContent.startsWith('Variation:')) {
          productVariant = variantElem.textContent.replace('Variation:', '').trim();
        }
      }
      // Build product link for the correct product details page (absolute URL)
      const baseUrl = "https://jbr-tanching-c-o.onrender.com";
      if (productId) {
        if (productType === 'sm') {
          productLink = `${baseUrl}/sm-productdetails?product_id=${productId}`;
        } else if (productType === 'sp') {
          productLink = `${baseUrl}/sp-productdetails?product_id=${productId}`;
        } else if (productType === 'f') {
          productLink = `${baseUrl}/f-productdetails?product_id=${productId}`;
        }
      }
      // Set hidden product link input
      let productLinkInput = document.getElementById('emailProductLink');
      if (!productLinkInput) {
        productLinkInput = document.createElement('input');
        productLinkInput.type = 'hidden';
        productLinkInput.id = 'emailProductLink';
        productLinkInput.name = 'product_link';
        document.getElementById('emailForm').appendChild(productLinkInput);
      }
      productLinkInput.value = productLink;
      // Set hidden product name input
      let productNameInput = document.getElementById('emailProductName');
      if (!productNameInput) {
        productNameInput = document.createElement('input');
        productNameInput.type = 'hidden';
        productNameInput.id = 'emailProductName';
        productNameInput.name = 'product_name';
        document.getElementById('emailForm').appendChild(productNameInput);
      }
      productNameInput.value = productName;
      // Set hidden product variant input
      let productVariantInput = document.getElementById('emailProductVariant');
      if (!productVariantInput) {
        productVariantInput = document.createElement('input');
        productVariantInput.type = 'hidden';
        productVariantInput.id = 'emailProductVariant';
        productVariantInput.name = 'product_variant';
        document.getElementById('emailForm').appendChild(productVariantInput);
      }
      productVariantInput.value = productVariant;

      document.getElementById('emailOrderId').value = orderId;
      // Leave the message textarea empty for user input only
      document.getElementById('emailMessage').value = '';
      document.getElementById('emailModalOverlay').style.display = 'flex';
      // Debug log
      console.log('Contact Seller Clicked:', {orderId, productName, productVariant, productLink, productType});
    }
  });
  // Show/hide custom subject input
  var subjectSelect = document.getElementById('emailSubject');
  var customSubjectInput = document.getElementById('customSubjectInput');
  subjectSelect.addEventListener('change', function() {
    if (this.value === 'Other') {
      customSubjectInput.style.display = 'block';
      customSubjectInput.required = true;
    } else {
      customSubjectInput.style.display = 'none';
      customSubjectInput.required = false;
    }
  });
  // Close modal
  document.getElementById('closeEmailModal').onclick = function() {
    document.getElementById('emailModalOverlay').style.display = 'none';
  };
  // Handle form submit via AJAX
  document.getElementById('emailForm').onsubmit = function(e) {
    e.preventDefault();
    var form = this;
    var formData = new FormData(form);
    // If custom subject, set it in FormData
    if (subjectSelect.value === 'Other') {
      formData.set('subject', customSubjectInput.value);
    }
    fetch('/api/contact-seller-email', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Message sent successfully!');
        form.reset();
        customSubjectInput.style.display = 'none';
        customSubjectInput.required = false;
        document.getElementById('emailModalOverlay').style.display = 'none';
      } else {
        alert('Failed to send message: ' + (data.message || 'Unknown error'));
      }
    })
    .catch(err => {
      alert('Network error. Please try again.');
    });
  };
});
</script>

</body>
</html>