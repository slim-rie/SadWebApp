{% extends "auth_base.html" %}
{% block title %}Home{% endblock %}
{% block content %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

<body>
  <div class="filter-section">
    <select class="categories-dropdown" id="categoryFilter">
      <option value="all">All Categories</option>
      {% for category in categories %}
      <option value="{{ category }}">{{ category }}</option>
      {% endfor %}
    </select>

    <div class="search">
      <input type="text" id="searchInput" placeholder="Search products..." />
      <button id="clearSearch" class="clear-btn" style="display: none;">✕</button>
    </div>
  </div>

  <div class="profile-container">
    <a href="#" class="profile-icon">
      <img src="{{ url_for('static', filename='pictures/saka.jpeg') }}" alt="Profile" height="40" />
    </a>
    <div class="dropdown-menu" id="profileMenu">
      <ul>
        <li><a href="{{url_for('auth.profile')}}">View Profile</a></li>
        <li>
          <a href="{{url_for('auth.cart')}}">Cart (<span id="cartCount">0</span>)</a>
        </li>
        <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
      </ul>
    </div>
  </div>

  <section class="product-container">
    {% for product in products %}
    <div class="box" data-category="{{ product.category }}" data-name="{{ product.name.lower() }}" data-description="{{ product.description.lower() }}">
      <img src="{{ product.image_url }}" alt="{{ product.name }}" />
      <h6>{{ product.name }}</h6>
      <p>{{ product.description }}</p>
      <p class="price">₱{{ "%.2f"|format(product.price) }}</p>
      <div class="box-actions">
        <button class="btn btn-buy">Buy now</button>
        <form action="{{ url_for('views.add_to_cart', product_id=product.id) }}" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-add-cart">Add to Cart</button>
        </form>
        <a href="{{ url_for('auth.contact_seller', product_id=product.id) }}" class="btn btn-contact">Contact Seller</a>
      </div>
    </div>
    {% endfor %}
  </section>

  <div class="no-results" style="display: none;">
    <p>No products found matching your search.</p>
  </div>

  <script>
    $(document).ready(function() {
      function filterProducts() {
        var category = $('#categoryFilter').val();
        var searchTerm = $('#searchInput').val().toLowerCase();
        var hasVisibleProducts = false;

        $('.box').each(function() {
          var $product = $(this);
          var productCategory = $product.data('category');
          var productName = $product.data('name');
          var productDesc = $product.data('description');
          
          var matchesCategory = (category === 'all' || productCategory === category);
          var matchesSearch = (productName.includes(searchTerm) || productDesc.includes(searchTerm));
          
          if (matchesCategory && matchesSearch) {
            $product.show();
            hasVisibleProducts = true;
          } else {
            $product.hide();
          }
        });

        // Show/hide no results message
        $('.no-results').toggle(!hasVisibleProducts);
        
        // Show/hide clear search button
        $('#clearSearch').toggle(searchTerm !== '');
      }

      // Category filter change
      $('#categoryFilter').change(filterProducts);

      // Search input
      var searchTimeout;
      $('#searchInput').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterProducts, 300);
      });

      // Clear search button
      $('#clearSearch').click(function() {
        $('#searchInput').val('');
        filterProducts();
      });

      // Update cart count on page load
      $.get('/get-cart-count', function(data) {
        $('#cartCount').text(data.count);
      });
    });
  </script>
</body>
{% endblock %}
